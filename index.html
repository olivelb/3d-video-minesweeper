<!DOCTYPE html>
<html lang="fr">

<head>
    <title>DÃ©mineur 3D - ModernisÃ©</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/style.css">

    <!-- Import Map pour rÃ©soudre 'three' dans les modules -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <!-- VidÃ©o utilisÃ©e comme texture -->
    <video id="image" preload="auto" loop muted autoplay style="display:none;" playsinline>
        <source src="images/storm_render.mp4" type="video/mp4">
    </video>
    <!-- Image utilisÃ©e comme texture (quand l'utilisateur uploade une image) -->
    <img id="custom-image-source" style="display:none;" />

    <div id="ui-container">
        <h1>DÃ©mineur 3D</h1>
        <p>Clic Gauche: RÃ©vÃ©ler | Clic Droit: Drapeau</p>
        <button id="hint-btn" class="control-btn" title="Obtenir un indice logique">ğŸ§© BESOIN D'AIDE</button>
        <button id="flag-style-btn" class="control-btn" style="margin-left: 10px;"
            title="Basculer vers les drapeaux 3D">â­
            Ã‰TOILES</button>
        <div id="hint-display">ğŸ§© Indices: 0</div>
        <button id="mute-btn" class="control-btn" title="Activer/DÃ©sactiver le son">ğŸ”‡ OFF</button>
        <button id="retry-btn" title="Recommencer au dernier coup sÃ»r">ğŸ” REESSAYER</button>
    </div>

    <div id="timer-display">â±ï¸ 00:00</div>
    <div id="score-display">ğŸ† Score: 0</div>

    <!-- Menu de dÃ©marrage -->
    <div id="menu-overlay">
        <div class="menu-box">
            <h2>Configuration</h2>
            <!-- Note: Presets are inserted via UIManager -->
            <div class="input-row">
                <div class="input-group">
                    <label>Largeur</label>
                    <input type="number" id="grid-width" value="30" min="10" max="200">
                </div>
                <div class="input-group">
                    <label>Hauteur</label>
                    <input type="number" id="grid-height" value="20" min="10" max="150">
                </div>
                <div class="input-group">
                    <label>Bombes</label>
                    <input type="number" id="bomb-count" value="50" min="1">
                </div>
            </div>
            <div class="input-group">
                <label>MÃ©dia de fond (optionnel)</label>
                <!-- Default Preset Selector -->
                <select id="background-preset"
                    style="width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer;">
                    <option value="video:images/storm_render.mp4">ğŸŒªï¸ Orage (VidÃ©o par dÃ©faut)</option>
                    <option value="image:images/default_texture_1.png">ğŸŒŒ NÃ©buleuse (Image)</option>
                    <option value="image:images/default_texture_2.png">ğŸ’ Cristal (Image)</option>
                    <option value="image:images/default_texture_3.png">ğŸŒ† NÃ©on Cyberpunk (Image)</option>
                    <option value="image:images/default_texture_4.png">ğŸŒŠ Or Liquide (Image)</option>
                </select>

                <div class="video-upload-container">
                    <input type="file" id="video-upload" accept="video/mp4,video/webm,video/ogg,image/*">
                    <label for="video-upload" class="video-upload-btn">
                        <span class="upload-icon">ğŸ“</span>
                        <span class="upload-text">Ou importer un fichier...</span>
                    </label>
                    <span id="video-filename" class="video-filename">Utilise le prÃ©rÃ©glage ci-dessus</span>
                </div>
                <div class="video-webcam">
                    <label class="webcam-label"><input type="checkbox" id="use-webcam"> Utiliser la webcam si
                        disponible</label>
                    <small class="hint">Si la webcam est refusÃ©e ou absente, on revient Ã  la vidÃ©o par dÃ©faut.</small>
                </div>
                <div class="input-row" style="margin-top: 10px;">
                    <div class="input-group">
                        <label class="checkbox-label"><input type="checkbox" id="hover-helper" checked> Aide au
                            survol</label>
                    </div>
                    <div class="input-group">
                        <label class="checkbox-label"><input type="checkbox" id="no-guess-mode"> Sans hasard (No
                            Guess)</label>
                    </div>
                </div>
            </div>
            <button id="start-btn">JOUER</button>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard-box">
            <h2>ğŸ† Meilleurs Scores</h2>
            <div id="leaderboard-list">
                <p class="no-scores">Aucun score enregistrÃ©</p>
            </div>
            <button id="clear-scores-btn" class="clear-btn">Effacer les scores</button>
        </div>
    </div>

    <div id="loading-overlay" style="display:none;">
        <div class="loading-box">
            <h2>GÃ©nÃ©ration de la grille...</h2>
            <div class="spinner"></div>
            <p id="loading-text">Recherche d'une configuration valide...</p>
            <p id="loading-details" style="font-size: 0.9em; color: #888;">Tentative 0 / 10000</p>
            <button id="cancel-gen-btn" class="cancel-btn">ARRÃŠTER</button>
        </div>
    </div>

    <div id="container"></div>

    <script type="module">
        import { MinesweeperGame } from './javascripts/Game.js';
        import { MinesweeperRenderer } from './javascripts/Renderer.js';
        import { ScoreManager } from './javascripts/ScoreManager.js';
        import { UIManager } from './javascripts/UIManager.js';

        let game, renderer;
        const scoreManager = new ScoreManager();
        let uiManager;

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize UI
            uiManager = new UIManager(null, null, scoreManager);

            uiManager.onStartGame = (width, height, bombs, useHoverHelper, noGuessMode) => {
                startGame(width, height, bombs, useHoverHelper, noGuessMode);
            };

            // Main Loop integration for Timer/Score updates
            setInterval(() => {
                if (game && renderer) {
                    const timerDisplay = document.getElementById('timer-display');
                    const scoreDisplay = document.getElementById('score-display');
                    const hintDisplay = document.getElementById('hint-display');

                    if (game.gameStartTime) {
                        const time = game.getElapsedTime();
                        timerDisplay.textContent = `â±ï¸ ${Math.floor(time / 60).toString().padStart(2, '0')}:${(time % 60).toString().padStart(2, '0')}`;
                        timerDisplay.classList.add('active');

                        // Score prediction
                        const score = scoreManager.calculateScore(game.width, game.height, game.bombCount, time, {
                            noGuessMode: game.noGuessMode,
                            hintCount: game.hintCount,
                            retryCount: game.retryCount
                        });
                        scoreDisplay.textContent = `ğŸ† Score: ${score.toLocaleString()}`;
                        scoreDisplay.classList.add('active');

                        // Hint count display
                        hintDisplay.textContent = `ğŸ§© Indices: ${game.hintCount}`;
                        hintDisplay.classList.toggle('active', game.hintCount > 0);

                        // Retry button visibility
                        const retryBtn = document.getElementById('retry-btn');
                        if (game.gameOver && game.lastMove) {
                            retryBtn.style.display = 'block';
                        } else {
                            retryBtn.style.display = 'none';
                        }
                    } else {
                        timerDisplay.classList.remove('active');
                        scoreDisplay.classList.remove('active');
                        hintDisplay.classList.remove('active');
                    }
                }
            }, 100);
        });

        function startGame(width, height, bombs, useHoverHelper, noGuessMode) {
            if (renderer) {
                renderer.dispose();
                renderer = null;
            }

            game = new MinesweeperGame(width, height, bombs);
            game.noGuessMode = noGuessMode;
            game.init();

            renderer = new MinesweeperRenderer(game, 'container', scoreManager, useHoverHelper);

            // Hint handling
            const hintBtn = document.getElementById('hint-btn');
            hintBtn.style.display = 'inline-flex';
            hintBtn.onclick = () => {
                const hint = game.getHint();
                if (hint) {
                    renderer.showHint(hint.x, hint.y, hint.type);
                } else {
                    // Visual feedback for no hint
                    hintBtn.classList.add('no-hint');
                    setTimeout(() => hintBtn.classList.remove('no-hint'), 500);
                }
            };

            // Retry handling
            const retryBtn = document.getElementById('retry-btn');
            retryBtn.onclick = () => {
                if (game.retryLastMove()) {
                    renderer.resetExplosion();
                    retryBtn.style.display = 'none';
                    document.getElementById('hint-btn').style.display = 'block';
                }
            };

            // Link UI manager to renderer for mute sync
            uiManager.setRenderer(renderer);

            // Wait for audio
            setTimeout(() => {
                if (renderer.soundManager) {
                    renderer.soundManager.resumeContext();
                    renderer.soundManager.setMute(uiManager.isMuted);
                }
            }, 100);

            // Game End Callback
            renderer.onGameEnd = () => {
                document.getElementById('hint-btn').style.display = 'none';
                document.getElementById('retry-btn').style.display = 'none';
                renderer.dispose();
                renderer = null;
                game = null;
                uiManager.showMenu();
            };
        }
    </script>
</body>

</html>