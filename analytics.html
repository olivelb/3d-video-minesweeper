<!DOCTYPE html>
<html lang="fr">

<head>
    <title>D√©mineur 3D - Analytics</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            overflow-y: auto;
            padding: 40px;
            min-height: 100vh;
        }

        .analytics-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .analytics-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .analytics-header h1 {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .analytics-header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(-5px);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px 10px 0 0;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: 800;
            color: #ffd700;
            display: block;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
        }

        .chart-card h3 {
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 1px;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .win-rate-high {
            color: #00ff88;
        }

        .win-rate-medium {
            color: #ffcc00;
        }

        .win-rate-low {
            color: #ff4444;
        }

        .no-data {
            text-align: center;
            padding: 60px;
            opacity: 0.6;
            font-style: italic;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .clear-btn {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid rgba(255, 0, 0, 0.4);
        }

        .actions {
            margin-top: 30px;
            text-align: center;
        }

        /* Sensitivity Analysis Styles */
        .sensitivity-card {
            background: rgba(255, 100, 100, 0.1);
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sensitivity-card.warning {
            background: rgba(255, 165, 0, 0.15);
            border-color: rgba(255, 165, 0, 0.4);
        }

        .sensitivity-card.danger {
            background: rgba(255, 0, 0, 0.15);
            border-color: rgba(255, 0, 0, 0.4);
        }

        .sensitivity-card h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .sensitivity-metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sensitivity-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            opacity: 0.8;
        }

        .metric-value {
            font-weight: 700;
        }

        .anomaly-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 700;
            margin-left: 10px;
        }

        .anomaly-badge.high {
            background: rgba(255, 0, 0, 0.3);
            color: #ff6666;
        }

        .anomaly-badge.medium {
            background: rgba(255, 165, 0, 0.3);
            color: #ffaa00;
        }

        .custom-upload-highlight {
            background: rgba(240, 147, 251, 0.1);
            border-left: 4px solid #f093fb;
        }

        @media (max-width: 600px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <div class="analytics-container">
        <a href="index.html" class="back-btn">‚Üê Retour au jeu</a>

        <div class="analytics-header">
            <h1>üìä Analytics Dashboard</h1>
            <p>Analyse comportementale et d√©tection de sensibilit√© aux m√©dias</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('general')">üìà Vue G√©n√©rale</button>
            <button class="tab-btn" onclick="showTab('sensitivity')">üß† Analyse de Sensibilit√©</button>
            <button class="tab-btn" onclick="showTab('history')">üìú Historique</button>
        </div>

        <!-- General Tab -->
        <div id="tab-general" class="tab-content active">
            <div id="stats-grid" class="stats-grid"></div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>üéØ Taux de Victoire par Fond</h3>
                    <div class="chart-container">
                        <canvas id="winRateChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>‚è±Ô∏è Temps de D√©cision Moyen</h3>
                    <div class="chart-container">
                        <canvas id="decisionTimeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h3>üìä Comparaison Pr√©r√©glages vs Uploads Personnalis√©s</h3>
                <div id="preset-vs-custom"></div>
            </div>
        </div>

        <!-- Sensitivity Analysis Tab -->
        <div id="tab-sensitivity" class="tab-content">
            <div class="chart-card">
                <h3>üîç D√©tection d'Anomalies sur Fichiers Upload√©s</h3>
                <p style="opacity: 0.7; margin-bottom: 20px;">
                    Cette analyse d√©tecte si un fichier upload√© (image/vid√©o personnelle) affecte n√©gativement vos
                    performances
                    par rapport √† votre niveau habituel. Des signes de distraction, h√©sitation ou attachement √©motionnel
                    sont recherch√©s.
                </p>
                <div id="sensitivity-analysis"></div>
            </div>

            <div class="chart-card" style="margin-top: 30px;">
                <h3>üìâ Indicateurs Comportementaux</h3>
                <div class="charts-grid" style="margin-bottom: 0;">
                    <div class="chart-container">
                        <canvas id="hesitationChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="attachmentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content">
            <div class="chart-card">
                <h3>üìú Historique Complet des Parties</h3>
                <div id="history-table"></div>
            </div>
        </div>

        <div class="actions">
            <button class="export-btn" onclick="exportCSV()">üì• Exporter CSV</button>
            <button class="export-btn clear-btn" onclick="clearData()">üóëÔ∏è Effacer les donn√©es</button>
        </div>
    </div>

    <script>
        const analyticsKey = 'minesweeper3d_analytics';
        const scoresKey = 'minesweeper3d_scores';
        let charts = {};

        function getAnalytics() {
            try { return JSON.parse(localStorage.getItem(analyticsKey)) || []; }
            catch { return []; }
        }

        function getScores() {
            try { return JSON.parse(localStorage.getItem(scoresKey)) || []; }
            catch { return []; }
        }

        function isCustomUpload(bg) {
            if (!bg) return false;
            return bg.startsWith('Custom:') || bg === 'Webcam';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ========== GENERAL TAB ==========
        function renderSummaryStats() {
            const events = getAnalytics().filter(e => e.type !== 'start');
            const wins = events.filter(e => e.type === 'win').length;
            const losses = events.filter(e => e.type === 'loss').length;
            const total = wins + losses;
            const winRate = total > 0 ? Math.round((wins / total) * 100) : 0;

            const customEvents = events.filter(e => isCustomUpload(e.background));
            const customWins = customEvents.filter(e => e.type === 'win').length;
            const customTotal = customEvents.length;
            const customWinRate = customTotal > 0 ? Math.round((customWins / customTotal) * 100) : 0;

            const avgDecision = events.filter(e => e.clickData?.avgDecisionTime)
                .reduce((sum, e) => sum + e.clickData.avgDecisionTime, 0) /
                (events.filter(e => e.clickData?.avgDecisionTime).length || 1);

            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <span class="stat-value">${total}</span>
                    <span class="stat-label">Parties Totales</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${winRate}%</span>
                    <span class="stat-label">Taux Global</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${customTotal}</span>
                    <span class="stat-label">Parties Custom</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value ${customWinRate < winRate - 15 ? 'win-rate-low' : ''}">${customWinRate}%</span>
                    <span class="stat-label">Taux Custom</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value">${Math.round(avgDecision / 1000)}s</span>
                    <span class="stat-label">D√©cision Moy.</span>
                </div>
            `;
        }

        function renderWinRateChart() {
            const events = getAnalytics().filter(e => e.type !== 'start');
            const bgStats = {};

            events.forEach(e => {
                const bg = e.background || 'Unknown';
                if (!bgStats[bg]) bgStats[bg] = { wins: 0, total: 0 };
                bgStats[bg].total++;
                if (e.type === 'win') bgStats[bg].wins++;
            });

            const labels = Object.keys(bgStats);
            const winRates = labels.map(bg => Math.round((bgStats[bg].wins / bgStats[bg].total) * 100));
            const colors = labels.map(bg => isCustomUpload(bg) ? 'rgba(240, 147, 251, 0.8)' : 'rgba(102, 126, 234, 0.8)');

            if (charts.winRate) charts.winRate.destroy();
            charts.winRate = new Chart(document.getElementById('winRateChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Taux de Victoire (%)',
                        data: winRates,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'rgba(255,255,255,0.7)', maxRotation: 45 }, grid: { display: false } }
                    }
                }
            });
        }

        function renderDecisionTimeChart() {
            const events = getAnalytics().filter(e => e.type !== 'start' && e.clickData?.avgDecisionTime);
            const bgStats = {};

            events.forEach(e => {
                const bg = e.background || 'Unknown';
                if (!bgStats[bg]) bgStats[bg] = { totalTime: 0, count: 0 };
                bgStats[bg].totalTime += e.clickData.avgDecisionTime;
                bgStats[bg].count++;
            });

            const labels = Object.keys(bgStats);
            const avgTimes = labels.map(bg => Math.round(bgStats[bg].totalTime / bgStats[bg].count / 1000 * 10) / 10);
            const colors = labels.map(bg => isCustomUpload(bg) ? 'rgba(240, 147, 251, 0.8)' : 'rgba(102, 126, 234, 0.8)');

            if (charts.decisionTime) charts.decisionTime.destroy();
            charts.decisionTime = new Chart(document.getElementById('decisionTimeChart'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Temps de D√©cision (s)',
                        data: avgTimes,
                        backgroundColor: colors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'rgba(255,255,255,0.7)', maxRotation: 45 }, grid: { display: false } }
                    }
                }
            });
        }

        function renderPresetVsCustom() {
            const events = getAnalytics().filter(e => e.type !== 'start');

            const presetEvents = events.filter(e => !isCustomUpload(e.background));
            const customEvents = events.filter(e => isCustomUpload(e.background));

            const presetWins = presetEvents.filter(e => e.type === 'win').length;
            const customWins = customEvents.filter(e => e.type === 'win').length;

            const presetWinRate = presetEvents.length > 0 ? Math.round((presetWins / presetEvents.length) * 100) : 0;
            const customWinRate = customEvents.length > 0 ? Math.round((customWins / customEvents.length) * 100) : 0;

            const presetAvgTime = presetEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.avgDecisionTime || 0), 0) / (presetEvents.filter(e => e.clickData).length || 1);
            const customAvgTime = customEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.avgDecisionTime || 0), 0) / (customEvents.filter(e => e.clickData).length || 1);

            const presetHesitations = presetEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.hesitations || 0), 0);
            const customHesitations = customEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.hesitations || 0), 0);

            const diff = customWinRate - presetWinRate;
            const diffClass = diff < -15 ? 'win-rate-low' : diff < -5 ? 'win-rate-medium' : 'win-rate-high';
            const diffLabel = diff < -15 ? '‚ö†Ô∏è √âcart significatif' : diff < -5 ? '‚ûñ √âcart mod√©r√©' : '‚úÖ Normal';

            document.getElementById('preset-vs-custom').innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>M√©trique</th>
                            <th>Pr√©r√©glages</th>
                            <th>Uploads Personnalis√©s</th>
                            <th>Analyse</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Parties jou√©es</td>
                            <td>${presetEvents.length}</td>
                            <td>${customEvents.length}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>Taux de victoire</td>
                            <td class="win-rate-high">${presetWinRate}%</td>
                            <td class="${customWinRate < presetWinRate - 15 ? 'win-rate-low' : ''}">${customWinRate}%</td>
                            <td class="${diffClass}">${diffLabel}</td>
                        </tr>
                        <tr>
                            <td>Temps de d√©cision moyen</td>
                            <td>${(presetAvgTime / 1000).toFixed(1)}s</td>
                            <td>${(customAvgTime / 1000).toFixed(1)}s</td>
                            <td>${customAvgTime > presetAvgTime * 1.3 ? '‚ö†Ô∏è H√©sitation d√©tect√©e' : '‚úÖ Normal'}</td>
                        </tr>
                        <tr>
                            <td>Pauses longues (>5s)</td>
                            <td>${presetHesitations}</td>
                            <td>${customHesitations}</td>
                            <td>${customHesitations > presetHesitations * 2 ? '‚ö†Ô∏è Distraction possible' : '‚úÖ Normal'}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // ========== SENSITIVITY TAB ==========
        function renderSensitivityAnalysis() {
            const events = getAnalytics().filter(e => e.type !== 'start');
            const customUploads = [...new Set(events.filter(e => isCustomUpload(e.background)).map(e => e.background))];

            if (customUploads.length === 0) {
                document.getElementById('sensitivity-analysis').innerHTML = '<p class="no-data">Aucun fichier personnalis√© d√©tect√©. Uploadez une image ou vid√©o pour commencer l\'analyse.</p>';
                return;
            }

            // Calculate baseline from presets
            const presetEvents = events.filter(e => !isCustomUpload(e.background));
            const baselineWinRate = presetEvents.length > 0 ?
                (presetEvents.filter(e => e.type === 'win').length / presetEvents.length) * 100 : 50;
            const baselineDecisionTime = presetEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.avgDecisionTime || 0), 0)
                / (presetEvents.filter(e => e.clickData).length || 1);

            let html = '';

            customUploads.forEach(upload => {
                const uploadEvents = events.filter(e => e.background === upload);
                const wins = uploadEvents.filter(e => e.type === 'win').length;
                const total = uploadEvents.length;
                const winRate = total > 0 ? (wins / total) * 100 : 0;

                const avgDecision = uploadEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.avgDecisionTime || 0), 0)
                    / (uploadEvents.filter(e => e.clickData).length || 1);
                const totalHesitations = uploadEvents.filter(e => e.clickData).reduce((s, e) => s + (e.clickData.hesitations || 0), 0);
                const maxPause = Math.max(...uploadEvents.filter(e => e.clickData).map(e => e.clickData.maxPause || 0));

                // Calculate anomaly scores
                const winRateDiff = baselineWinRate - winRate;
                const decisionDiff = ((avgDecision - baselineDecisionTime) / baselineDecisionTime) * 100;

                let severityClass = '';
                let severityLabel = '';
                if (winRateDiff > 30 || decisionDiff > 50) {
                    severityClass = 'danger';
                    severityLabel = 'üö® Sensibilit√© √âlev√©e';
                } else if (winRateDiff > 15 || decisionDiff > 25) {
                    severityClass = 'warning';
                    severityLabel = '‚ö†Ô∏è Sensibilit√© Mod√©r√©e';
                } else {
                    severityLabel = '‚úÖ Normal';
                }

                html += `
                    <div class="sensitivity-card ${severityClass}">
                        <h4>üìÅ ${upload} ${severityLabel}</h4>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Parties jou√©es</span>
                            <span class="metric-value">${total}</span>
                        </div>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Taux de victoire</span>
                            <span class="metric-value ${winRate < baselineWinRate - 15 ? 'win-rate-low' : ''}">${Math.round(winRate)}% 
                                ${winRateDiff > 15 ? `<span class="anomaly-badge ${winRateDiff > 30 ? 'high' : 'medium'}">-${Math.round(winRateDiff)}% vs baseline</span>` : ''}
                            </span>
                        </div>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Temps de d√©cision moyen</span>
                            <span class="metric-value">${(avgDecision / 1000).toFixed(1)}s 
                                ${decisionDiff > 25 ? `<span class="anomaly-badge ${decisionDiff > 50 ? 'high' : 'medium'}">+${Math.round(decisionDiff)}% plus lent</span>` : ''}
                            </span>
                        </div>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Pauses longues d√©tect√©es</span>
                            <span class="metric-value">${totalHesitations} ${totalHesitations > 5 ? '<span class="anomaly-badge medium">H√©sitation fr√©quente</span>' : ''}</span>
                        </div>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Plus longue pause</span>
                            <span class="metric-value">${(maxPause / 1000).toFixed(1)}s ${maxPause > 30000 ? '<span class="anomaly-badge high">Distraction majeure</span>' : ''}</span>
                        </div>
                        <div class="sensitivity-metric">
                            <span class="metric-label">Utilisations r√©p√©t√©es</span>
                            <span class="metric-value">${total} ${total > 10 ? '<span class="anomaly-badge medium">Attachement possible</span>' : ''}</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('sensitivity-analysis').innerHTML = html;
        }

        function renderBehavioralCharts() {
            const events = getAnalytics().filter(e => e.type !== 'start' && e.clickData);

            // Hesitation chart
            const bgHesitations = {};
            events.forEach(e => {
                const bg = e.background || 'Unknown';
                if (!bgHesitations[bg]) bgHesitations[bg] = 0;
                bgHesitations[bg] += e.clickData.hesitations || 0;
            });

            const hesLabels = Object.keys(bgHesitations);
            const hesValues = hesLabels.map(bg => bgHesitations[bg]);
            const hesColors = hesLabels.map(bg => isCustomUpload(bg) ? 'rgba(255, 100, 100, 0.8)' : 'rgba(100, 200, 100, 0.8)');

            if (charts.hesitation) charts.hesitation.destroy();
            charts.hesitation = new Chart(document.getElementById('hesitationChart'), {
                type: 'bar',
                data: {
                    labels: hesLabels,
                    datasets: [{
                        label: 'H√©sitations (pauses >5s)',
                        data: hesValues,
                        backgroundColor: hesColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: 'H√©sitations par Fond', color: 'white' } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'rgba(255,255,255,0.7)', maxRotation: 45 }, grid: { display: false } }
                    }
                }
            });

            // Attachment chart (usage count)
            const bgUsage = {};
            events.forEach(e => {
                const bg = e.background || 'Unknown';
                if (!bgUsage[bg]) bgUsage[bg] = 0;
                bgUsage[bg]++;
            });

            const usageLabels = Object.keys(bgUsage).filter(bg => isCustomUpload(bg));
            const usageValues = usageLabels.map(bg => bgUsage[bg]);

            if (charts.attachment) charts.attachment.destroy();
            charts.attachment = new Chart(document.getElementById('attachmentChart'), {
                type: 'doughnut',
                data: {
                    labels: usageLabels.length > 0 ? usageLabels : ['Aucun upload'],
                    datasets: [{
                        data: usageValues.length > 0 ? usageValues : [1],
                        backgroundColor: ['rgba(240, 147, 251, 0.8)', 'rgba(102, 126, 234, 0.8)', 'rgba(255, 200, 100, 0.8)', 'rgba(100, 255, 200, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: 'R√©partition Uploads Personnalis√©s', color: 'white' },
                        legend: { labels: { color: 'white' } }
                    }
                }
            });
        }

        // ========== HISTORY TAB ==========
        function renderHistoryTable() {
            const events = getAnalytics().filter(e => e.type !== 'start').reverse();

            if (events.length === 0) {
                document.getElementById('history-table').innerHTML = '<p class="no-data">Aucun historique disponible.</p>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>R√©sultat</th>
                            <th>Fond</th>
                            <th>Difficult√©</th>
                            <th>Temps</th>
                            <th>D√©cision Moy.</th>
                            <th>H√©sitations</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            events.slice(0, 50).forEach(e => {
                const date = new Date(e.date).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                const resultClass = e.type === 'win' ? 'win-rate-high' : 'win-rate-low';
                const resultLabel = e.type === 'win' ? 'üèÜ Victoire' : 'üí• D√©faite';
                const isCustom = isCustomUpload(e.background);

                html += `
                    <tr class="${isCustom ? 'custom-upload-highlight' : ''}">
                        <td>${date}</td>
                        <td class="${resultClass}">${resultLabel}</td>
                        <td>${e.background || 'Unknown'} ${isCustom ? 'üìÅ' : ''}</td>
                        <td>${e.difficulty || 'N/A'}</td>
                        <td>${formatTime(e.time || 0)}</td>
                        <td>${e.clickData ? (e.clickData.avgDecisionTime / 1000).toFixed(1) + 's' : '-'}</td>
                        <td>${e.clickData?.hesitations || 0}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('history-table').innerHTML = html;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function exportCSV() {
            const events = getAnalytics();
            if (events.length === 0) { alert('Aucune donn√©e.'); return; }

            const headers = ['date', 'type', 'background', 'isCustomUpload', 'difficulty', 'bombs', 'time', 'avgDecisionTime', 'hesitations', 'maxPause', 'playerId', 'codename'];
            const rows = events.map(e => [
                e.date, e.type, e.background, isCustomUpload(e.background), e.difficulty, e.bombs, e.time,
                e.clickData?.avgDecisionTime || '', e.clickData?.hesitations || '', e.clickData?.maxPause || '',
                e.playerId, e.codename
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => { csv += row.map(cell => `"${cell || ''}"`).join(',') + '\n'; });

            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `minesweeper_sensitivity_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function clearData() {
            if (confirm('Effacer toutes les donn√©es analytics?')) {
                localStorage.removeItem(analyticsKey);
                location.reload();
            }
        }

        // Initialize
        renderSummaryStats();
        renderWinRateChart();
        renderDecisionTimeChart();
        renderPresetVsCustom();
        renderSensitivityAnalysis();
        renderBehavioralCharts();
        renderHistoryTable();
    </script>
</body>

</html>